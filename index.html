<!doctype html>

<html lang="es">
<head>
  <style>
    /* üé® Car√°tula con brillo navide√±o */
    .meta img{
      width:54px;height:54px;object-fit:cover;border-radius:10px;margin-left:8px;
      display:none;box-shadow:0 0 10px #0008;transition:transform .6s ease, box-shadow .6s ease;
    }
    .meta img.shine{animation:coverGlow 3.2s ease-in-out infinite alternate}
    @keyframes coverGlow{
      0%{transform:scale(1);box-shadow:0 0 10px #0008,0 0 0 #00ff0033}
      100%{transform:scale(1.05);box-shadow:0 0 14px #0008,0 0 22px #ff000080}
    }
  </style>
</head>
<body>
  <script>
  (function(){
    const cover = document.getElementById('cover');
    const meta  = document.getElementById('metaText');
    let last='';function clean(s){ return String(s||'').replace(/\s+/g,' ').trim(); }

function parseTitleArtist(s){
  s = clean(s).replace(/^üé∂\s*Sonando ahora:\s*/i,'').replace(/^\"|\"$/g,'');
  if(s.includes(' ‚Äî ')){ const p=s.split(' ‚Äî '); return {title:clean(p[0]).replace(/^\"|\"$/g,''), artist:clean(p.slice(1).join(' ‚Äî '))}; }
  if(s.includes(' - ')){ const p=s.split(' - '); return {artist:clean(p[0]), title:clean(p.slice(1).join(' - '))}; }
  return {title:s, artist:''};
}

async function fetchCover(q){
  if(!q){ cover.style.display='none'; cover.classList.remove('shine'); return; }
  try{
    const r = await fetch('https://itunes.apple.com/search?media=music&limit=1&term=' + encodeURIComponent(q));
    const j = await r.json();
    if(j && j.results && j.results.length){
      let url = j.results[0].artworkUrl100 || j.results[0].artworkUrl60;
      if(url){
        url = url.replace(/100x100bb\.(jpg|png)/,'300x300bb.$1');
        cover.src = url;
        cover.style.display = 'block';
        cover.classList.add('shine'); // activa animaci√≥n
        return;
      }
    }
  }catch(e){}
  cover.style.display='none';
  cover.classList.remove('shine'); // desactiva animaci√≥n si no hay imagen
}

setInterval(()=>{
  const t = clean(meta.textContent||'');
  if(t && t!==last){
    last = t;
    const pa = parseTitleArtist(t);
    const term = clean(`${pa.title} ${pa.artist}`);
    fetchCover(term);
  }
}, 5000);

})(); </script>

  <!-- ‚ú® Brillo de car√°tula reactivo al ritmo (Web Audio API) -->  <script>
  (function(){
    const cover = document.getElementById('cover');
    const audio = document.getElementById('radio');
    if(!cover || !audio) return;

    // Intentar habilitar CORS para analizar audio (si el servidor lo permite)
    try{ audio.crossOrigin = audio.crossOrigin || 'anonymous'; }catch(e){}

    let ctx, analyser, src, data, raf;

    function initCtx(){
      if(ctx) return true;
      try{
        ctx = new (window.AudioContext||window.webkitAudioContext)();
        analyser = ctx.createAnalyser();
        analyser.fftSize = 1024; // menor latencia visual
        data = new Uint8Array(analyser.frequencyBinCount);
        src = ctx.createMediaElementSource(audio);
        src.connect(analyser);
        // Mantener reproducci√≥n normal
        src.connect(ctx.destination);
        return true;
      }catch(err){
        // Fallback: dejar solo la animaci√≥n por CSS si no se puede analizar (CORS/permiso)
        console.debug('Analyzer no disponible:', err);
        return false;
      }
    }

    function level(){
      if(!analyser) return 0;
      analyser.getByteFrequencyData(data);
      // Promedio simple (puedes ponderar graves)
      let sum=0; for(let i=0;i<data.length;i++){ sum += data[i]; }
      return sum / data.length / 255; // 0..1
    }

    function loop(){
      const v = level();
      // Mapear a brillo/escala (suave)
      const scale = 1 + v*0.10; // hasta 10% zoom
      // Mezclar rojo/verde: m√°s verde en niveles medios, rojo en picos
      const red   = Math.min(255, Math.floor(80 + v*175));
      const green = Math.min(255, Math.floor(80 + (0.6+0.4*Math.sin(performance.now()/300)) * 175 * Math.max(v,0.2)));
      const glow1 = `0 0 14px #0008`;
      const glow2 = `0 0 ${Math.floor(26 + v*28)}px rgba(${red},0,0,0.8)`;
      const glow3 = `0 0 ${Math.floor(20 + v*24)}px rgba(0,${green},0,0.7)`;
      cover.style.transform = `scale(${scale.toFixed(3)})`;
      cover.style.boxShadow = `${glow1}, ${glow2}, ${glow3}`;
      raf = requestAnimationFrame(loop);
    }

    function startReactive(){
      if(!initCtx()) return; // si falla, no hacemos nada
      if(ctx.state === 'suspended') ctx.resume().catch(()=>{});
      if(!raf) raf = requestAnimationFrame(loop);
    }

    function stopReactive(){
      if(raf){ cancelAnimationFrame(raf); raf=null; }
      // Vuelve a un brillo dorado suave por defecto
      cover.style.boxShadow = '0 0 10px #0008, 0 0 18px #ff000066, 0 0 18px #00ff0066';
      cover.style.transform = 'scale(1.02)';
    }

    // Arrancar cuando haya interacci√≥n o cuando se desmutee
    document.addEventListener('click', startReactive, {once:true});
    audio.addEventListener('play',  startReactive);
    audio.addEventListener('pause', stopReactive);
  })();
  </script>  <!-- üéá Guirnalda reactiva al ritmo (si existe #garland) -->  <script>
  (function(){
    const audio = document.getElementById('radio');
    const garland = document.getElementById('garland');
    if(!audio || !garland) return; // si la guirnalda no existe en este documento, no hace nada

    try{ audio.crossOrigin = audio.crossOrigin || 'anonymous'; }catch(e){}

    let ctx, analyser, src, data, raf;

    function initCtx(){
      if(ctx) return true;
      try{
        ctx = new (window.AudioContext||window.webkitAudioContext)();
        analyser = ctx.createAnalyser();
        analyser.fftSize = 1024;
        data = new Uint8Array(analyser.frequencyBinCount);
        src = ctx.createMediaElementSource(audio);
        src.connect(analyser);
        src.connect(ctx.destination);
        return true;
      }catch(err){
        console.debug('Analyzer guirnalda no disponible:', err);
        return false;
      }
    }

    const bulbs = ()=> Array.from(garland.querySelectorAll('.bulb'));

    function energy(){
      if(!analyser) return 0;
      analyser.getByteFrequencyData(data);
      // prioriza graves/medios para efecto de beat
      let sum=0, count=0;
      for(let i=2;i<Math.min(80,data.length);i++){ sum += data[i]; count++; }
      const avg = count? (sum/count)/255 : 0;
      return Math.min(1, Math.max(0, avg));
    }

    function loop(){
      const v = energy(); // 0..1
      const now = performance.now();
      const bs = bulbs();
      for(let i=0;i<bs.length;i++){
        const b = bs[i];
        // Fase para que no todos pulsen igual
        const phase = (Math.sin((now/250)+(i*0.9))+1)/2; // 0..1
        const k = 0.3 + 0.9*v*phase; // intensidad combinada
        const blur = Math.floor(10 + k*24);
        const y = (phase*2 - 1) * (v*2); // leve movimiento vertical
        b.style.transform = `translateY(${y.toFixed(2)}px)`;
        b.style.boxShadow = `0 0 ${blur}px currentColor, 0 0 ${Math.floor(blur*1.6)}px currentColor`;
        b.style.opacity = (0.6 + 0.4*k).toFixed(2);
      }
      raf = requestAnimationFrame(loop);
    }

    function start(){ if(!initCtx()) return; if(ctx.state==='suspended') ctx.resume().catch(()=>{}); if(!raf) raf=requestAnimationFrame(loop); }
    function stop(){ if(raf){ cancelAnimationFrame(raf); raf=null; } }

    document.addEventListener('click', start, {once:true});
    audio.addEventListener('play', start);
    audio.addEventListener('pause', stop);
  })();
  </script></body>
</html>
